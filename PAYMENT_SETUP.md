# üè¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã YooKassa

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ç–µ—Å—Ç–æ–≤–æ–π –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º YooKassa –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ AdaptEd Russia.

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 18+
- YooKassa –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª—é—á–µ–π)
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQLite –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –í –ø–∞–ø–∫–µ server
cd server
npm install

# –í –ø–∞–ø–∫–µ client
cd ../client
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `env.example` –≤ `server/.env`:

```bash
cd server
cp env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª:

```env
# Database
DATABASE_URL="file:./dev.db"

# JWT Secret
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"

# Server Configuration
PORT=3003
NODE_ENV=development

# Client URL (for CORS and redirects)
CLIENT_URL=http://localhost:3000

# YooKassa Configuration (—Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏)
YOOKASSA_SHOP_ID="your-yookassa-shop-id"
YOOKASSA_SECRET_KEY="your-yookassa-secret-key"
```

### 3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª—é—á–µ–π YooKassa

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [YooKassa](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç](https://yookassa.ru/integration)
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `Shop ID` –∏ `Secret Key` –≤ `.env` —Ñ–∞–π–ª

### 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
cd server

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞
npx prisma generate

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
npx prisma db push

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
npx tsx src/scripts/init-payment-data.ts
```

### 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤

```bash
# –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞ (–≤ –ø–∞–ø–∫–µ server)
npm run dev

# –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–≤ –ø–∞–ø–∫–µ client)
cd ../client
npm run dev
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: `http://localhost:3000/payment-test`

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

#### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã | CVC | –î–∞—Ç–∞ |
|----------|-------------|-----|------|
| –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ | `4111111111111111` | `123` | –õ—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ |
| –ù–µ—É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ | `4000000000000002` | `123` | –õ—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ |
| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ | `4000000000009995` | `123` | –õ—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ |
| –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ | `4000000000000069` | `123` | –õ—é–±–∞—è –ø—Ä–æ—à–µ–¥—à–∞—è –¥–∞—Ç–∞ |
| –ù–µ–≤–µ—Ä–Ω—ã–π CVC | `4000000000000127` | `000` | –õ—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞ |

#### –°–ë–ü –Ω–æ–º–µ—Ä–∞

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ |
|----------|----------------|
| –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ | `+79001234567` |
| –ù–µ—É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ | `+79001234568` |

## üîß API Endpoints

### –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫

```http
GET /api/payments/plans
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

```http
POST /api/payments/create-payment
Authorization: Bearer <token>
Content-Type: application/json

{
  "planId": "plan_id",
  "paymentMethod": "CARD"
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

```http
GET /api/payments/payment/:paymentId
Authorization: Bearer <token>
```

### –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞

```http
POST /api/payments/payment/:paymentId/cancel
Authorization: Bearer <token>
```

### –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

```http
GET /api/payments/subscription
Authorization: Bearer <token>
```

### –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

```http
GET /api/payments/history
Authorization: Bearer <token>
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

```http
GET /api/payments/test-data
```

## üîÑ Webhook

–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç YooKassa:

```http
POST /api/payments/webhook
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### SubscriptionPlan
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞
- `price` - —Ü–µ–Ω–∞
- `currency` - –≤–∞–ª—é—Ç–∞ (RUB)
- `interval` - –∏–Ω—Ç–µ—Ä–≤–∞–ª (MONTHLY/YEARLY)
- `features` - JSON –º–∞—Å—Å–∏–≤ —Ñ—É–Ω–∫—Ü–∏–π
- `isActive` - –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–ª–∞–Ω

### Payment
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `amount` - —Å—É–º–º–∞
- `currency` - –≤–∞–ª—é—Ç–∞
- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ
- `status` - —Å—Ç–∞—Ç—É—Å (PENDING/SUCCEEDED/CANCELED/FAILED)
- `paymentMethod` - —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (CARD/SBP/WALLET)
- `yooKassaPaymentId` - ID –ø–ª–∞—Ç–µ–∂–∞ –≤ YooKassa

### Subscription
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `userId` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `planId` - ID –ø–ª–∞–Ω–∞
- `status` - —Å—Ç–∞—Ç—É—Å (ACTIVE/EXPIRED/CANCELED/PENDING)
- `startDate` - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
- `endDate` - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- `autoRenew` - –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
- `paymentId` - ID –ø–ª–∞—Ç–µ–∂–∞

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–µ (`test_mode: true`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –í—Å–µ API endpoints –∑–∞—â–∏—â–µ–Ω—ã middleware
- Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –æ—Ç YooKassa

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã –∏ –Ω–æ–º–µ—Ä–∞
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ
4. **–ü—Ä–æ–¥–∞–∫—à–µ–Ω**: –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª—é—á–∏ YooKassa

## üÜò –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞ "Invalid credentials"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏

### –û—à–∏–±–∫–∞ "Database connection failed"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞

### –û—à–∏–±–∫–∞ "Payment not found"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `paymentId`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é YooKassa
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ 